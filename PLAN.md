# Haskell開発環境 構築プラン

このドキュメントは、GitHub Codespaces上でHaskellを用いた競技プログラミング環境を構築するための作業計画を記述します。

## 0. 開発方針

- **コンテナのリビルドとセッション:**
  コンテナのリビルドごとにインタラクティブなセッションは失われます。そのため、作業の進捗、決定事項、参照情報など、必要なすべての情報は常にこの`PLAN.md`に記録し、誰が作業を引き継いでも分かるようにします。この方針自体も、常にこのドキュメントに記載しておくものとします。

- **作業の進め方:**
  - **細やかなコミット:** 動作確認ができた、あるいは論理的にキリの良い単位で、積極的にコミットを作成します。これにより、問題が発生した際に安全に作業を巻き戻せるようにします。
  - **一時ファイルの取り扱い:** 検証用のファイル（`app/Main.hs`など）であっても、変更が確実に反映されるよう、必要であればコミットします。これにより、ファイルの状態に関する認識の齟齬を防ぎます。
  - **アプローチの記録:** 複数の解決策が考えられる場合は、それぞれの長所・短所を`PLAN.md`に記述し、なぜそのアプローチを選択したかの記録を残します。

- **参照情報:**
  - [Haskeller のための AtCoder 言語アップデート 2025](https://zenn.dev/toyboot4e/articles/haskell-on-atcoder-2025)
  - [AtCoder 2025 language update for Haskell (GHC 9.8.4) - インストールスクリプト](https://gist.github.com/toyboot4e/04b902271997b3c865cc91014720ec40)

## 1. 大目標

- GitHub Codespaces を利用して、AtCoderのHaskell開発環境を安定して利用できる状態にする。

## 2. 中期目標

- まずはローカルPC上で、Dockerコンテナとして開発環境を構築し、意図したライブラリが導入された状態を再現する。

## 3. 作業ステップ

- [x] **ステップ1: 基本のHaskell実行環境の構築**
    - （完了）

- [x] **ステップ2: AtCoderジャッジ環境の再現 (完了)**
    - これまでの試行錯誤を経て、`ac-library-hs`が`cabal repl`環境で正しく認識・インポートできるようになりました。
    - **主な解決策:**
        1.  **Cabal設定ファイルの互換性問題の解決:** 公式Gistの構文が非互換だったため、最小限の`.cabal`/`.project`ファイルを使用し、`cabal v2-freeze`で環境に合った`freeze`ファイルを自動生成するように変更しました。
        2.  **プロジェクト構造の最適化:** `executable`のみのプロジェクトでは`cabal repl`が依存関係を適切に読み込めない問題があったため、`library`コンポーネントを導入し、`executable`がそれに依存する堅牢な構成に変更しました。
        3.  **明示的なGHCiセッションの起動:** `cabal repl lib:atcoder-env`と明示的にライブラリコンポーネントを指定することで、依存関係が確実にロードされるようになりました。
        4.  **正しいモジュールパスの特定:** `ac-library-hs`のFenwickTreeモジュールは`Data.Vector.FenwickTree`ではなく`AtCoder.FenwickTree`として公開されていることをGHCiの補完機能で確認し、正しいパスでの`import`に成功しました。

- [ ] **ステップ3: `ac-library-hs`の動作確認と競技プログラミングワークフローへの統合 (Cabalベースの実行は断念)**
    - [x] **フェーズ1: Cabal経由での実行ファイル出力問題のデバッグ:**
          - `cabal build`でビルドした実行ファイルが、直接実行しても`cabal run`しても標準出力に何も表示しない問題が発生。
          - C言語の「Hello World」および`ghc`コマンドで直接コンパイルしたHaskellの「Hello World」は正常に動作し、出力が確認された。
          - これは、`cabal`がGHCを呼び出す際の特定のオプションやリンケージ設定（例: `-static`フラグの強制など）が、このAArch64環境下で問題のある実行ファイルを生成している可能性が高いと結論付けられた。
          - **結論:** この問題はGHC/Cabalの深い部分に根ざしており、競技プログラミングの環境構築という本質的な目的から外れ、デバッグに多大な時間を要するため、**`cabal`による実行ファイルのビルド・実行は断念する。**
    - [ ] **新しいアプローチ: 競技プログラミングコードのコンパイルと実行には`ghc`コマンドを直接使用する。**
          1.  `app/Main.hs`の内容を元に戻す（`main = return ()`）。
          2.  `hs/test_contest/`のような新しいディレクトリを作成し、競技プログラミングコードを作成する（例: `Main.hs`）。
          3.  `ghc -O2 --make Main.hs` のように`ghc`コマンドで直接コンパイルし、`./Main`で実行して出力が確認できるか検証する。
          4.  `ac-library-hs`を利用したコードを記述し、同様に`ghc`でコンパイル・実行して動作確認を行う。
          5.  `cabal repl lib:atcoder-env`は、ライブラリ関数のインタラクティブなテストのために引き続き利用する。
    - [ ] この状態を `feat: Transition to direct GHC compilation for competitive programming code` のようなコミットメッセージで保存する。

- [ ] **ステップ4: GitHub Codespacesでの動作確認**
    - [ ] ローカルでのコンテナ構築が完了した構成をGitHubにプッシュする。
    - [ ] GitHub上でCodespacesを起動し、ローカルと同様に環境が構築されることを確認する。
    - [ ] **フェーズ2: 競技プログラミングの実際のワークフローでの確認 (atcoder-cli/online-judge-tools)**
          1.  `hs/`配下に新しいコンテストディレクトリを作成する。
          2.  `atcoder-cli`を使用して問題をフェッチし、テンプレートを生成する。
          3.  生成されたHaskellテンプレートを修正し、`ac-library-hs`（例: FenwickTree）を利用するコードを記述する。
          4.  `online-judge-tools`によるサンプルテスト、および`GHCi`での検証が問題なく動作することを確認する。
    - [ ] この状態を `feat: Verify ac-library-hs functionality and integrate with AtCoderCLI workflow` のようなコミットメッセージで保存する。

- [ ] **ステップ4: GitHub Codespacesでの動作確認**
    - [ ] ローカルでのコンテナ構築が完了した構成をGitHubにプッシュする。
    - [ ] GitHub上でCodespacesを起動し、ローカルと同様に環境が構築されることを確認する。
